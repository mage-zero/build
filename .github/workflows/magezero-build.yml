name: MageZero Build

on:
  workflow_call:
    inputs:
      image_tag:
        description: Image tag or build identifier (used in artifact name).
        required: false
        default: ${{ github.sha }}
        type: string
      setup_php:
        description: Install PHP tooling on the runner.
        required: false
        default: true
        type: boolean
      mz_control_url:
        description: Base URL for mz-control.
        required: true
        type: string
      build_command:
        description: Legacy build command that replaces the default MageZero build (deprecated).
        required: false
        default: ""
        type: string
      extra_build_command:
        description: Optional extra build steps to run before the default MageZero build.
        required: false
        default: ""
        type: string
    secrets:
      COMPOSER_AUTH:
        required: false

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      deploy_url: ${{ steps.creds.outputs.deploy_url }}
      php_version: ${{ steps.creds.outputs.php_version }}
      artifact_name: ${{ steps.meta.outputs.artifact_name }}
      object_key: ${{ steps.meta.outputs.object_key }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build metadata
        id: meta
        run: |
          ARTIFACT_NAME="build-${GITHUB_REPOSITORY//\//-}-${IMAGE_TAG}.tar.zst"
          OBJECT_KEY="builds/${GITHUB_REPOSITORY}/${ARTIFACT_NAME}"
          echo "artifact_name=${ARTIFACT_NAME}" >> "${GITHUB_OUTPUT}"
          echo "object_key=${OBJECT_KEY}" >> "${GITHUB_OUTPUT}"
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}

      - name: Request build context
        id: creds
        run: |
          BASE_URL="${MZ_CONTROL_URL%/}"
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST "${BASE_URL}/v1/build/presign" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"repository\":\"${GITHUB_REPOSITORY}\",\"ref\":\"${GITHUB_REF}\",\"object_key\":\"${OBJECT_KEY}\",\"bucket\":\"backups\",\"method\":\"PUT\",\"expires_in\":60}")"
          RESPONSE_BODY="${RESPONSE%$'\n'*}"
          RESPONSE_CODE="${RESPONSE##*$'\n'}"
          if [ "${RESPONSE_CODE}" -ge 300 ]; then
            echo "mz-control error (${RESPONSE_CODE}): ${RESPONSE_BODY}"
            exit 1
          fi
          RESPONSE="${RESPONSE_BODY}"
          UPLOAD_URL="$(echo "${RESPONSE}" | jq -r '.url')"
          if [ -z "${UPLOAD_URL}" ] || [ "${UPLOAD_URL}" = "null" ]; then
            echo "mz-control error: missing upload URL"
            exit 1
          fi
          echo "deploy_url=$(echo "${RESPONSE}" | jq -r '.deploy_url')" >> "${GITHUB_OUTPUT}"
          PHP_VERSION="$(printf '%s' "${RESPONSE}" | jq -r '.php_version // "8.2"')"
          echo "php_version=${PHP_VERSION}" >> "${GITHUB_OUTPUT}"
        env:
          MZ_CONTROL_URL: ${{ inputs.mz_control_url }}
          OBJECT_KEY: ${{ steps.meta.outputs.object_key }}

  create_build:
    name: Create Build
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log PHP selection
        run: |
          echo "Requested PHP version: ${{ needs.prepare.outputs.php_version }}"

      - name: Setup PHP
        if: ${{ inputs.setup_php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ needs.prepare.outputs.php_version }}
          extensions: rrd
          tools: composer:v2

      - name: Verify PHP
        if: ${{ inputs.setup_php }}
        run: php -v

      - name: Build Magento artifact
        run: |
          set -e
          if [ -f app/etc/config.php ]; then
            cp app/etc/config.php app/etc/config.php.bak
            trap 'mv app/etc/config.php.bak app/etc/config.php' EXIT
          fi
          php -r '
          $path = "app/etc/config.php";
          $config = file_exists($path) ? include $path : [];
          if (!is_array($config)) { $config = []; }
          if (!isset($config["scopes"])) {
            $config["scopes"] = [
              "websites" => [
                "admin" => [
                  "website_id" => "0",
                  "code" => "admin",
                  "name" => "Admin",
                  "sort_order" => "0",
                  "default_group_id" => "0",
                  "is_default" => "0",
                ],
                "base" => [
                  "website_id" => "1",
                  "code" => "base",
                  "name" => "Default",
                  "sort_order" => "0",
                  "default_group_id" => "1",
                  "is_default" => "1",
                ],
              ],
              "stores" => [
                "admin" => [
                  "store_id" => "0",
                  "code" => "admin",
                  "website_id" => "0",
                  "group_id" => "0",
                  "name" => "Admin",
                  "sort_order" => "0",
                  "is_active" => "1",
                ],
                "default" => [
                  "store_id" => "1",
                  "code" => "default",
                  "website_id" => "1",
                  "group_id" => "1",
                  "name" => "Default",
                  "sort_order" => "1",
                  "is_active" => "1",
                ],
              ],
              "groups" => [
                0 => [
                  "group_id" => "0",
                  "website_id" => "0",
                  "name" => "Admin",
                  "root_category_id" => "0",
                  "default_store_id" => "0",
                  "code" => "default",
                ],
                1 => [
                  "group_id" => "1",
                  "website_id" => "1",
                  "name" => "Default",
                  "root_category_id" => "1",
                  "default_store_id" => "1",
                  "code" => "default",
                ],
              ],
            ];
          }
          file_put_contents($path, "<?php\nreturn " . var_export($config, true) . ";\n");
          '
          if [ -n "${LEGACY_BUILD_COMMAND}" ]; then
            echo "Running legacy build_command override."
            printf '%s\n' "${LEGACY_BUILD_COMMAND}" > /tmp/mz-build-override.sh
            . /tmp/mz-build-override.sh
            exit 0
          fi
          if [ -n "${EXTRA_BUILD_COMMAND}" ]; then
            echo "Running extra build steps."
            printf '%s\n' "${EXTRA_BUILD_COMMAND}" > /tmp/mz-extra-build.sh
            . /tmp/mz-extra-build.sh
          fi
          composer install --no-dev --prefer-dist
          bin/magento setup:di:compile
          composer dump-autoload --optimize
          bin/magento setup:static-content:deploy -f
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}
          LEGACY_BUILD_COMMAND: ${{ inputs.build_command }}
          EXTRA_BUILD_COMMAND: ${{ inputs.extra_build_command }}

      - name: Generate OPcache preload file
        if: ${{ inputs.setup_php && inputs.build_command == '' }}
        run: |
          PRELOAD_PATH="app/opcache-preload.php"
          cat > /tmp/mz-opcache-preload.php <<'PHP'
          <?php
          $root = getcwd();
          $preloadPath = $root . '/app/opcache-preload.php';
          $files = [];
          $shouldSkip = function (string $path): bool {
              $normalized = str_replace('\\', '/', strtolower($path));
              return strpos($normalized, '/test/') !== false
                  || strpos($normalized, '/tests/') !== false
                  || strpos($normalized, '/dev/') !== false;
          };
          $classmapPath = $root . '/vendor/composer/autoload_classmap.php';
          if (is_file($classmapPath)) {
              $classmap = require $classmapPath;
              if (is_array($classmap)) {
                  $files = array_values(array_filter($classmap, function ($path) use ($shouldSkip) {
                      return is_string($path) && !$shouldSkip($path);
                  }));
              }
          }
          $scanDirs = [
              $root . '/app/code',
              $root . '/generated/code',
              $root . '/generated/metadata',
          ];
          foreach ($scanDirs as $dir) {
              if (!is_dir($dir)) {
                  continue;
              }
              $iterator = new RecursiveIteratorIterator(
                  new RecursiveDirectoryIterator($dir, FilesystemIterator::SKIP_DOTS)
              );
              foreach ($iterator as $file) {
                  if ($file->isFile() && $file->getExtension() === 'php') {
                      $pathName = $file->getPathname();
                      if ($shouldSkip($pathName)) {
                          continue;
                      }
                      $files[] = $pathName;
                  }
              }
          }
          $files = array_values(array_unique($files));
          sort($files);
          $relative = [];
          $rootPrefix = $root . DIRECTORY_SEPARATOR;
          foreach ($files as $file) {
              $real = realpath($file);
              if ($real === false) {
                  continue;
              }
              if (strpos($real, $rootPrefix) !== 0) {
                  continue;
              }
              $path = substr($real, strlen($rootPrefix));
              if ($path === 'app/opcache-preload.php') {
                continue;
              }
              $relative[] = $path;
          }
          $relative = array_values(array_unique($relative));
          $lines = [
              '<?php',
              '// Generated at build time. Do not edit.',
              'if (!function_exists("opcache_compile_file")) { return; }',
              '$root = dirname(__DIR__);',
              '$files = ' . var_export($relative, true) . ';',
              'foreach ($files as $file) {',
              '    $path = $root . "/" . $file;',
              '    if (is_file($path)) {',
              '        @opcache_compile_file($path);',
              '    }',
              '}',
          ];
          if (!is_dir(dirname($preloadPath))) {
              mkdir(dirname($preloadPath), 0775, true);
          }
          file_put_contents($preloadPath, implode(PHP_EOL, $lines) . PHP_EOL);
          PHP
          if [ -f "vendor/composer/autoload_classmap.php" ]; then
            php /tmp/mz-opcache-preload.php || true
          else
            echo "Skipping preload generation; classmap not available."
          fi
          if [ ! -s "${PRELOAD_PATH}" ]; then
            echo "<?php return;" > "${PRELOAD_PATH}"
          fi
          echo "OPcache preload file: ${PRELOAD_PATH}"

      - name: Build artifact
        run: |
          ARTIFACT_NAME="${ARTIFACT_NAME}"
          ARTIFACT_PATH="/tmp/${ARTIFACT_NAME}"
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> "${GITHUB_ENV}"
          echo "ARTIFACT_PATH=${ARTIFACT_PATH}" >> "${GITHUB_ENV}"
          tar -I 'zstd -10 -T0' -cf "${ARTIFACT_PATH}" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='var/cache' \
            --exclude='var/page_cache' \
            .
        env:
          ARTIFACT_NAME: ${{ needs.prepare.outputs.artifact_name }}

      - name: Upload artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: magezero-build-${{ github.run_id }}
          path: ${{ env.ARTIFACT_PATH }}
          if-no-files-found: error

  deploy_build:
    name: Deploy Build
    runs-on: ubuntu-latest
    needs: [prepare, create_build]
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: magezero-build-${{ github.run_id }}
          path: /tmp

      - name: Request upload URL
        id: presign
        run: |
          BASE_URL="${MZ_CONTROL_URL%/}"
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST "${BASE_URL}/v1/build/presign" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"repository\":\"${GITHUB_REPOSITORY}\",\"ref\":\"${GITHUB_REF}\",\"object_key\":\"${OBJECT_KEY}\",\"bucket\":\"backups\",\"method\":\"PUT\",\"expires_in\":1800}")"
          RESPONSE_BODY="${RESPONSE%$'\n'*}"
          RESPONSE_CODE="${RESPONSE##*$'\n'}"
          if [ "${RESPONSE_CODE}" -ge 300 ]; then
            echo "mz-control error (${RESPONSE_CODE}): ${RESPONSE_BODY}"
            exit 1
          fi
          UPLOAD_URL="$(echo "${RESPONSE_BODY}" | jq -r '.url')"
          if [ -z "${UPLOAD_URL}" ] || [ "${UPLOAD_URL}" = "null" ]; then
            echo "mz-control error: missing upload URL"
            exit 1
          fi
          echo "::add-mask::${UPLOAD_URL}"
          echo "upload_url=${UPLOAD_URL}" >> "${GITHUB_OUTPUT}"
        env:
          MZ_CONTROL_URL: ${{ inputs.mz_control_url }}
          OBJECT_KEY: ${{ needs.prepare.outputs.object_key }}

      - name: Upload artifact to R2
        run: |
          ARTIFACT_PATH="/tmp/${ARTIFACT_NAME}"
          if [ ! -f "${ARTIFACT_PATH}" ]; then
            echo "Build artifact not found: ${ARTIFACT_PATH}"
            ls -la /tmp || true
            exit 1
          fi
          curl -fsS -X PUT --upload-file "${ARTIFACT_PATH}" "${UPLOAD_URL}"
        env:
          ARTIFACT_NAME: ${{ needs.prepare.outputs.artifact_name }}
          UPLOAD_URL: ${{ steps.presign.outputs.upload_url }}

      - name: Trigger deployment
        if: ${{ needs.prepare.outputs.deploy_url != '' }}
        run: |
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          curl -fsS -X POST "${DEPLOY_URL}" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"artifact\":\"${OBJECT_KEY}\"}"
        env:
          DEPLOY_URL: ${{ needs.prepare.outputs.deploy_url }}
          OBJECT_KEY: ${{ needs.prepare.outputs.object_key }}
