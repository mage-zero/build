name: MageZero Build

on:
  workflow_call:
    inputs:
      image_tag:
        description: Image tag or build identifier (used in artifact name).
        required: false
        default: ${{ github.sha }}
        type: string
      setup_php:
        description: Install PHP tooling on the runner.
        required: false
        default: true
        type: boolean
      mz_control_url:
        description: Base URL for mz-control.
        required: true
        type: string
      build_command:
        description: Optional build command to prepare the artifact.
        required: false
        default: ""
        type: string
    secrets:
      COMPOSER_AUTH:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Request build context
        id: creds
        run: |
          BASE_URL="${MZ_CONTROL_URL%/}"
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST "${BASE_URL}/v1/build/credentials" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"repository\":\"${GITHUB_REPOSITORY}\",\"ref\":\"${GITHUB_REF}\"}")"
          RESPONSE_BODY="${RESPONSE%$'\n'*}"
          RESPONSE_CODE="${RESPONSE##*$'\n'}"
          if [ "${RESPONSE_CODE}" -ge 300 ]; then
            echo "mz-control error (${RESPONSE_CODE}): ${RESPONSE_BODY}"
            exit 1
          fi
          RESPONSE="${RESPONSE_BODY}"
          echo "deploy_url=$(echo "${RESPONSE}" | jq -r '.deploy_url')" >> "${GITHUB_OUTPUT}"
          PHP_VERSION="$(printf '%s' "${RESPONSE}" | jq -r '.php_version // "8.2"')"
          echo "php_version=${PHP_VERSION}" >> "${GITHUB_OUTPUT}"
        env:
          MZ_CONTROL_URL: ${{ inputs.mz_control_url }}

      - name: Preflight upload URL
        run: |
          BASE_URL="${MZ_CONTROL_URL%/}"
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          ARTIFACT_NAME="build-${GITHUB_REPOSITORY//\//-}-${IMAGE_TAG}.tar.zst"
          OBJECT_KEY="builds/${GITHUB_REPOSITORY}/${ARTIFACT_NAME}"
          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST "${BASE_URL}/v1/build/presign" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"repository\":\"${GITHUB_REPOSITORY}\",\"ref\":\"${GITHUB_REF}\",\"object_key\":\"${OBJECT_KEY}\",\"bucket\":\"backups\",\"method\":\"PUT\",\"expires_in\":60}")"
          RESPONSE_BODY="${RESPONSE%$'\n'*}"
          RESPONSE_CODE="${RESPONSE##*$'\n'}"
          if [ "${RESPONSE_CODE}" -ge 300 ]; then
            echo "mz-control error (${RESPONSE_CODE}): ${RESPONSE_BODY}"
            exit 1
          fi
          UPLOAD_URL="$(echo "${RESPONSE_BODY}" | jq -r '.url')"
          if [ -z "${UPLOAD_URL}" ] || [ "${UPLOAD_URL}" = "null" ]; then
            echo "mz-control error: missing upload URL"
            exit 1
          fi
        env:
          MZ_CONTROL_URL: ${{ inputs.mz_control_url }}
          IMAGE_TAG: ${{ inputs.image_tag }}

      - name: Log PHP selection
        run: |
          echo "Requested PHP version: ${{ steps.creds.outputs.php_version }}"

      - name: Setup PHP
        if: ${{ inputs.setup_php }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ steps.creds.outputs.php_version }}
          extensions: rrd
          tools: composer:v2

      - name: Verify PHP
        if: ${{ inputs.setup_php }}
        run: php -v

      - name: Prepare build
        if: ${{ inputs.build_command != '' }}
        run: ${{ inputs.build_command }}
        env:
          COMPOSER_AUTH: ${{ secrets.COMPOSER_AUTH }}

      - name: Generate OPcache preload file
        if: ${{ inputs.setup_php }}
        run: |
          PRELOAD_PATH="var/opcache-preload.php"
          cat > /tmp/mz-opcache-preload.php <<'PHP'
          <?php
          $root = getcwd();
          $preloadPath = $root . '/var/opcache-preload.php';
          $files = [];
          $classmapPath = $root . '/vendor/composer/autoload_classmap.php';
          if (is_file($classmapPath)) {
              $classmap = require $classmapPath;
              if (is_array($classmap)) {
                  $files = array_values($classmap);
              }
          }
          $scanDirs = [
              $root . '/app/code',
              $root . '/generated/code',
              $root . '/generated/metadata',
          ];
          foreach ($scanDirs as $dir) {
              if (!is_dir($dir)) {
                  continue;
              }
              $iterator = new RecursiveIteratorIterator(
                  new RecursiveDirectoryIterator($dir, FilesystemIterator::SKIP_DOTS)
              );
              foreach ($iterator as $file) {
                  if ($file->isFile() && $file->getExtension() === 'php') {
                      $files[] = $file->getPathname();
                  }
              }
          }
          $files = array_values(array_unique($files));
          sort($files);
          $relative = [];
          $rootPrefix = $root . DIRECTORY_SEPARATOR;
          foreach ($files as $file) {
              $real = realpath($file);
              if ($real === false) {
                  continue;
              }
              if (strpos($real, $rootPrefix) !== 0) {
                  continue;
              }
              $path = substr($real, strlen($rootPrefix));
              if ($path === 'var/opcache-preload.php') {
                  continue;
              }
              $relative[] = $path;
          }
          $relative = array_values(array_unique($relative));
          $lines = [
              '<?php',
              '// Generated at build time. Do not edit.',
              'if (!function_exists("opcache_compile_file")) { return; }',
              '$root = dirname(__DIR__);',
              '$files = ' . var_export($relative, true) . ';',
              'foreach ($files as $file) {',
              '    $path = $root . "/" . $file;',
              '    if (is_file($path)) {',
              '        @opcache_compile_file($path);',
              '    }',
              '}',
          ];
          if (!is_dir(dirname($preloadPath))) {
              mkdir(dirname($preloadPath), 0775, true);
          }
          file_put_contents($preloadPath, implode(PHP_EOL, $lines) . PHP_EOL);
          PHP
          if [ -f "vendor/composer/autoload_classmap.php" ]; then
            php /tmp/mz-opcache-preload.php || true
          else
            echo "Skipping preload generation; classmap not available."
          fi
          if [ ! -s "${PRELOAD_PATH}" ]; then
            echo "<?php return;" > "${PRELOAD_PATH}"
          fi
          echo "OPcache preload file: ${PRELOAD_PATH}"

      - name: Build artifact
        run: |
          ARTIFACT_NAME="build-${GITHUB_REPOSITORY//\//-}-${IMAGE_TAG}.tar.zst"
          ARTIFACT_PATH="/tmp/${ARTIFACT_NAME}"
          echo "ARTIFACT_NAME=${ARTIFACT_NAME}" >> "${GITHUB_ENV}"
          echo "ARTIFACT_PATH=${ARTIFACT_PATH}" >> "${GITHUB_ENV}"
          tar -I 'zstd -10 -T0' -cf "${ARTIFACT_PATH}" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='var/cache' \
            --exclude='var/page_cache' \
            .
        env:
          IMAGE_TAG: ${{ inputs.image_tag }}

      - name: Request upload URL
        id: presign
        run: |
          BASE_URL="${MZ_CONTROL_URL%/}"
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          OBJECT_KEY="builds/${GITHUB_REPOSITORY}/${ARTIFACT_NAME}"
          RESPONSE="$(curl -sS -w "\n%{http_code}" -X POST "${BASE_URL}/v1/build/presign" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"repository\":\"${GITHUB_REPOSITORY}\",\"ref\":\"${GITHUB_REF}\",\"object_key\":\"${OBJECT_KEY}\",\"bucket\":\"backups\",\"method\":\"PUT\",\"expires_in\":1800}")"
          RESPONSE_BODY="${RESPONSE%$'\n'*}"
          RESPONSE_CODE="${RESPONSE##*$'\n'}"
          if [ "${RESPONSE_CODE}" -ge 300 ]; then
            echo "mz-control error (${RESPONSE_CODE}): ${RESPONSE_BODY}"
            exit 1
          fi
          UPLOAD_URL="$(echo "${RESPONSE_BODY}" | jq -r '.url')"
          if [ -z "${UPLOAD_URL}" ] || [ "${UPLOAD_URL}" = "null" ]; then
            echo "mz-control error: missing upload URL"
            exit 1
          fi
          echo "::add-mask::${UPLOAD_URL}"
          echo "upload_url=${UPLOAD_URL}" >> "${GITHUB_OUTPUT}"
        env:
          MZ_CONTROL_URL: ${{ inputs.mz_control_url }}

      - name: Upload artifact to R2
        run: |
          curl -fsS -X PUT --upload-file "${ARTIFACT_PATH}" "${UPLOAD_URL}"
        env:
          UPLOAD_URL: ${{ steps.presign.outputs.upload_url }}

      - name: Trigger deployment
        if: ${{ steps.creds.outputs.deploy_url != '' }}
        run: |
          TOKEN="$(curl -fsS "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=mz-control" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" | jq -r '.value')"
          curl -fsS -X POST "${DEPLOY_URL}" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"artifact\":\"builds/${GITHUB_REPOSITORY}/${ARTIFACT_NAME}\"}"
        env:
          DEPLOY_URL: ${{ steps.creds.outputs.deploy_url }}
